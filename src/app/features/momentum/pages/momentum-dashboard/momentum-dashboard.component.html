<div class="main-content bg-light" [class.panel-open]="isPanelOpen()">
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h1 class="page-title">
                    <i class="bi bi-graph-up-arrow"></i> Momentum Stocks Dashboard
                </h1>
            </div>
            <div class="text-end">
                <input type="text" placeholder="Select Date" class="form-control d-inline-block w-auto" bsDatepicker
                    #dp="bsDatepicker" [bsConfig]="bsConfig" [maxDate]="maxDate" [(ngModel)]="selectedDate"
                    (bsValueChange)="onDateChange($event)">
                <button class="btn btn-outline-secondary light-secondary-border border-0" type="button"
                    (click)="dp.show()">
                    <i class="bi bi-calendar3"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="count-card" (click)="filterByAction('STRONG BUY')"
                ngClass="{{ selectedTab() === 'STRONG BUY' ? 'selected-strong-buy' : '' }}">
                <div class="count-label">
                    Strong Buy
                </div>
                <div class="count-value text-success">{{ countStrongBuy() }}</div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="count-card" (click)="filterByAction('BUY')"
                ngClass="{{ selectedTab() === 'BUY' ? 'selected-buy' : '' }}">
                <div class="count-label">
                    Buy
                </div>
                <div class="count-value text-primary">{{ countBuy() }}</div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="count-card" (click)="filterByAction('ACCUMULATE')"
                ngClass="{{ selectedTab() === 'ACCUMULATE' ? 'selected-accumulate' : '' }}">
                <div class="count-label">
                    Accumulate
                </div>
                <div class="count-value text-warning">{{ countAccumulate() }}</div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="count-card" (click)="filterByAction('HOLD')"
                ngClass="{{ selectedTab() === 'HOLD' ? 'selected-hold' : '' }}">
                <div class="count-label">
                    Hold Pattern
                </div>
                <div class="count-value text-hold">{{ countHold() }}</div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="count-card" (click)="filterByAction('AVOID')"
                ngClass="{{ selectedTab() === 'AVOID' ? 'selected-avoid' : '' }}">
                <div class="count-label">
                    Avoid Pattern
                </div>
                <div class="count-value text-danger">{{ countAvoid() }}</div>
            </div>
        </div>
    </div>


    <div id="tableContainer">
        @if (isLoading()) {
        <div class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading momentum signals...</p>
        </div>
        } @else if (filteredData().length === 0) {
        <div class="loading">
            <p>No signals found</p>
        </div>
        } @else {
        <table class="table table-hover table-sm mb-0">
            <thead>
                <tr>
                    <th width="10%">Symbol</th>
                    <th width="10%">Indices</th>
                    <th width="10%">Industry</th>
                    <th width="10%">Connfidence</th>
                    <th width="10%">Price</th>
                    <th width="10%">Target</th>
                </tr>
            </thead>
            <tbody>
                @for (stock of filteredData(); track stock.symbol; let i = $index) {
                <tr (click)="showDetailPanel(stock)">
                    <td class="fw-medium"> {{ stock.symbol }} </td>
                    <td> {{ stock.indices }} </td>
                    <td> {{ stock.industry }} </td>
                    <td>
                        <span class="text-success fw-bold fs-6">
                            {{ stock.confidence }}
                        </span>
                        <span class="small text-muted"> ({{ stock.total_score | number:'1.1-1' }}) </span>
                    </td>
                    <td>₹{{ stock.current_price | number:'1.0-0' }}</td>
                    <td>₹{{ stock.target_price | number:'1.0-0' }}</td>
                </tr>
                }
            </tbody>
        </table>
        }
    </div>

</div>

<div class="detail-panel" [class.active]="isPanelOpen()">
    @if (selectedStock(); as stock) {
    <div class="detail-panel-header">
        <button class="close-panel" (click)="closeDetailPanel()">
            <i class="bi bi-x-lg"></i>
        </button>
        <h2 class="detail-panel-title" [class.text-primary]="true">{{ stock.symbol }}</h2>
        <p class="detail-panel-subtitle">{{ stock.industry }}</p>
    </div>

    <div class="detail-panel-content">

        <div class="detail-score-card" [style.border-color]="getScoreColor(stock.total_score)"
            [style.background-color]="getScoreColor(stock.total_score) + '15'">
            <div class="detail-score-value" [style.color]="getScoreColor(stock.total_score)">
                {{ stock.total_score | number:'1.1-1' }}
            </div>
            <div class="detail-score-label">Momentum Score (0-10)</div>
        </div>

        <div class="detail-section">
            <div class="detail-section-title">
                <i class="bi bi-calculator"></i> Trading Plan
            </div>
            <div class="trading-plan-card">
                <div class="trading-plan-item">
                    <span class="trading-plan-label">Entry Price</span>
                    <span class="trading-plan-value">₹{{ stock.current_price | number:'1.2-2' }}</span>
                </div>
                <div class="trading-plan-item">
                    <span class="trading-plan-label">Target Price (11%)</span>
                    <span class="trading-plan-value value-target">₹{{ stock.target_price | number:'1.2-2' }}</span>
                </div>
                <div class="trading-plan-item">
                    <span class="trading-plan-label">Stop Loss (4%)</span>
                    <span class="trading-plan-value value-stop">₹{{ stock.stop_loss | number:'1.2-2' }}</span>
                </div>
                <div class="trading-plan-item">
                    <span class="trading-plan-label">Expected Days</span>
                    <span class="trading-plan-value">{{ stock.expected_days }} days</span>
                </div>
            </div>
        </div>

        <div class="detail-section">
            <div class="detail-section-title">
                <i class="bi bi-graph-up"></i> Technical Strength ({{ stock.technical_score | number:'1.1-1' }}/4)
            </div>
            <div class="detail-metric">
                <span class="detail-metric-label">52W High Distance</span>
                <span class="detail-metric-value" [class.text-success]="stock.dist_from_52w >= -5"
                    [class.text-muted]="stock.dist_from_52w < -5">
                    {{ stock.dist_from_52w | number:'1.1-1' }}%
                </span>
            </div>
            <div class="detail-metric">
                <span class="detail-metric-label">Volume Trend (60D)</span>
                <span class="detail-metric-value" [class.text-success]="stock.volume_trend_60d > 0"
                    [class.text-danger]="stock.volume_trend_60d <= 0">
                    {{ stock.volume_trend_60d > 0 ? '+' : '' }}{{ stock.volume_trend_60d | number:'1.1-1' }}%
                </span>
            </div>
        </div>

        <div class="detail-section">
            <div class="detail-section-title">
                <i class="bi bi-shield-check"></i> Quality of Buying ({{ stock.quality_score | number:'1.1-1' }}/3)
            </div>
            <div class="detail-metric">
                <span class="detail-metric-label">Delivery % (10D Avg)</span>
                <span class="detail-metric-value" [class.text-success]="stock.delivery_avg_10d >= 50">
                    {{ stock.delivery_avg_10d | number:'1.1-1' }}%
                </span>
            </div>
            <div class="detail-metric">
                <span class="detail-metric-label">Delivery Spike</span>
                <span class="detail-metric-value">
                    @if (stock.delivery_spike) {
                    <i class="bi bi-check-circle-fill text-success"></i> Yes
                    } @else {
                    <i class="bi bi-x-circle text-muted"></i> No
                    }
                </span>
            </div>
            <div class="detail-metric">
                <span class="detail-metric-label">Pattern</span>
                <span class="detail-metric-value"
                    [class.text-danger]="stock.delivery_vs_price_pattern === 'ACCUMULATION'">
                    {{ stock.delivery_vs_price_pattern }}
                    @if (stock.delivery_vs_price_pattern === 'ACCUMULATION') {
                    <i class="bi bi-fire"></i>
                    }
                </span>
            </div>
        </div>

        <div class="detail-section">
            <div class="detail-section-title">
                <i class="bi bi-briefcase"></i> Fundamental Backdrop ({{ stock.fundamental_score | number:'1.1-1' }}/3)
            </div>
            <div class="detail-metric">
                <span class="detail-metric-label">Profit Growth (YoY)</span>
                <span class="detail-metric-value">
                    {{ stock.profit_growth ? (stock.profit_growth | number:'1.1-1') + '%' : 'N/A' }}
                </span>
            </div>
            <div class="detail-metric">
                <span class="detail-metric-label">Profit vs Peers</span>
                <span class="detail-metric-value" [class.text-success]="stock.profit_vs_peers > 0"
                    [class.text-danger]="stock.profit_vs_peers <= 0">
                    {{ stock.profit_vs_peers ? (stock.profit_vs_peers > 0 ? '+' : '') + (stock.profit_vs_peers |
                    number:'1.1-1') + '%' : 'N/A' }}
                </span>
            </div>
        </div>

        <div class="detail-section">
            <div class="detail-section-title">
                <i class="bi bi-lightbulb"></i> Investment Insight
            </div>
            <div class="insight-card">
                <strong>{{ getInsightTitle(stock) }}</strong>
                {{ getInsightDescription(stock) }}
            </div>
        </div>
    </div>
    }
</div>