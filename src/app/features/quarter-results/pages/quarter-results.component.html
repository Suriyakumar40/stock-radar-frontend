<main class="main-content">
    <div class="page-header d-flex justify-content-between align-items-center">
        <h1 class="page-title mb-0">Quarter Results Dashboard</h1>
        <div class="d-flex gap-2">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="Search stocks..." [(ngModel)]="search"
                    (keydown.enter)="onSearchChange(search)">
                <button class="btn btn-outline-secondary light-secondary-border" type="button" (click)="onSearchChange(search)">
                    <i class="bi bi-search"></i>
                </button>
            </div>
            <div class="input-group">
                <input type="text" placeholder="Select Quarter Month" class="form-control" bsDatepicker #dp="bsDatepicker"
                    [bsConfig]="bsConfig" [maxDate]="maxDate" [(ngModel)]="periodEnd" [datesDisabled]="disabledMonths" (bsValueChange)="onDateSelect($event)">
                <button class="btn btn-outline-secondary light-secondary-border" type="button" (click)="dp.show()">
                    <i class="bi bi-calendar3"></i>  
                </button>
            </div>
        </div>
    </div>

    <!-- NAVIGATION TABS -->
    <nav class="nav-tabs-custom mb-4" *ngIf="!detailViewActive()">
        <button class="nav-tab" [class.active]="currentView() === 'indices'" (click)="setView('indices')">
            <i class="bi bi-layers me-2"></i>BY INDEX
        </button>
        <button class="nav-tab" [class.active]="currentView() === 'industry'" (click)="setView('industry')">
            <i class="bi bi-building me-2"></i>BY INDUSTRY
        </button>
        <button class="nav-tab" [class.active]="currentView() === 'rating'" (click)="setView('rating')">
            <i class="bi bi-star me-2"></i>BY RATING
        </button>
    </nav>

    <!-- OVERVIEW SECTION -->
    <div class="overview-section animate-fade-in" *ngIf="!detailViewActive()">

        <!-- View: Indices -->
        <div class="overview-grid" *ngIf="currentView() === 'indices'">
            <div class="overview-card" *ngFor="let item of indicesData()" [ngClass]="item.ratingClass"
                (click)="showDetail('index', item.name)">
                <div class="card-title">{{ item.name }}</div>
                <div class="card-stats">
                    <div class="card-count">{{ item.count }}</div>
                    <div class="card-breakdown">
                        <div class="text-success">{{ item.explosive }}
                            Explosive</div>
                        <div class="text-warning"> {{ item.exceptional }}
                            Exceptional</div>
                        <div class="text-info"> {{ item.good }} Good</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- View: Industries -->
        <div class="overview-grid" *ngIf="currentView() === 'industry'">
            <div class="overview-card" *ngFor="let item of industryData()" [ngClass]="item.ratingClass"
                (click)="showDetail('industry', item.name)">
                <div class="card-title">{{ item.name }}</div>
                <div class="card-stats">
                    <div class="card-count">{{ item.count }}</div>
                    <div class="card-breakdown">
                        <div class="text-success"> {{ item.explosive }} Explosive</div>
                        <div class="text-warning"> {{ item.exceptional }} Exceptional</div>
                        <div class="text-info">âœ“ {{ item.good }} Good</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- View: Ratings -->
        <div class="overview-grid" *ngIf="currentView() === 'rating'">
            <div class="overview-card" *ngFor="let item of ratingData()" [ngClass]="item.styleClass"
                (click)="showDetail('rating', item.name)">
                <div class="card-label"> Score {{ item.scoreRange }}</div>
                <div class="card-title">{{ item.name }}</div>
                <div class="card-stats">
                    <div class="card-count">{{ item.count }}</div>
                    <div class="card-breakdown">
                        <div>Avg Profit: {{ item.avgProfit }}%</div>
                        <div>Total Stocks</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DETAIL SECTION -->
    <div class="detail-view animate-fade-in" *ngIf="detailViewActive()">
        <div class="detail-header">
            <h2 class="detail-title mb-0">
                <span class="text-muted fs-6 d-block mb-1 text-uppercase">{{ selectedFilterType() }}</span>
                {{ selectedFilterValue() }}
            </h2>
            <button class="back-btn" (click)="goBack()">
                <i class="bi bi-arrow-left me-2"></i>BACK TO OVERVIEW
            </button>
        </div>

        <!-- Filters inside Detail View -->
        <div class="filter-bar">
            <button class="filter-btn" [class.active]="detailRatingFilter() === 'ALL'"
                (click)="setDetailRatingFilter('ALL')">ALL</button>
            <button class="filter-btn" [class.active]="detailRatingFilter() === 'RECENT'"
                (click)="setDetailRatingFilter('RECENT')">RECENT</button>
            <button class="filter-btn" [class.active]="detailRatingFilter() === 'EXPLOSIVE'"
                (click)="setDetailRatingFilter('EXPLOSIVE')">EXPLOSIVE</button>
            <button class="filter-btn" [class.active]="detailRatingFilter() === 'EXCEPTIONAL'"
                (click)="setDetailRatingFilter('EXCEPTIONAL')">EXCEPTIONAL</button>
            <button class="filter-btn" [class.active]="detailRatingFilter() === 'GOOD'"
                (click)="setDetailRatingFilter('GOOD')">GOOD</button>
            <button class="filter-btn" [class.active]="detailRatingFilter() === 'AVERAGE'"
                (click)="setDetailRatingFilter('AVERAGE')">AVERAGE</button>
        </div>

        <!-- Responsive Table -->
        <div class="stock-table-container">
            <div class="stock-table-header d-none d-md-grid">
                <div>RANK</div>
                <div>SYMBOL</div>
                <div>INDUSTRY</div>
                <div class="text-end">SALES %</div>
                <div class="text-end">PROFIT %</div>
                <div class="text-end">OPM %</div>
                <div class="text-center">SCORE</div>
                <div class="text-center">RATING</div>
            </div>

            <div class="stock-list">
                <div class="stock-row" *ngFor="let stock of filteredStocks(); let i = index">
                    <!-- Mobile Label handled via CSS or simple stacking -->
                    <div class="rank">{{ i + 1 }}</div>
                    <div class="symbol">
                        {{ stock.symbol }}
                        <i *ngIf="stock.isFno" class="bi bi-lightning-fill text-warning" title="F&O Stock" style="font-size: 1.2em;"></i>
                    </div>
                    <div class="industry text-truncate" title="{{stock.industry}}">{{ stock.industry }} ({{ stock.boardMeetingDate }})</div>
                    <div class="metric text-end" [class.positive]="stock.salesGrowth > 0" [class.neutral]="stock.salesGrowth <= 0">
                        <span class="d-md-none text-muted me-2">Sales:</span>{{ stock.salesGrowth }}%
                    </div>
                    <div class="metric text-end" [class.positive]="stock.profitGrowth > 0"
                        [class.neutral]="stock.profitGrowth <= 0">
                        <span class="d-md-none text-muted me-2">Profit:</span>{{ stock.profitGrowth }}%
                    </div>
                    <div class="metric text-end">
                        <span class="d-md-none text-muted me-2">OPM:</span>{{ stock.opm }}%
                    </div>
                    <div class="text-center">
                        <span class="d-md-none text-muted me-2">Score:</span>
                        <span class="score-badge" [style.background]="getScoreColor(stock.ratingScore)">{{ stock.ratingScore }}/9</span>
                    </div>
                    <div class="text-center">
                        <span class="rating-badge rating-{{ stock.rating | lowercase }}">{{ stock.rating }}</span>
                    </div>
                </div>

                <!-- Empty State -->
                <div class="empty-state" *ngIf="filteredStocks().length === 0">
                    <i class="bi bi-bar-chart empty-icon"></i>
                    <p>No stocks found matching these criteria.</p>
                </div>
            </div>
        </div>
    </div>

</main>